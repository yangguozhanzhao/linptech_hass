
<script src="lib/jquery-3.2.1.min.js"></script>
<script src="lib/moment.min.js"></script>
<script src="lib/svg.js"></script>
<script src="lib/svg.draggable.js"></script>



<!-- As documented here for chrome, removes the need for touchstart -->
<meta name="viewport" content="width=device-width">

<dom-module id="ha-floorplan">

  <template>
    <style>
      .loading-container {
        text-align: center;
        padding: 8px;
      }

      .loading {
        height: 0px;
        overflow: hidden;
      }

      #errors {
        color: #FF0000;
        display: none;
      }

      #warnings {
        color: #FF851B;
        display: none;
      }

      #debug {
        color: #000000;
        display: none;
      }

      .draggable {
        cursor: move;
        border: 1px solid #ccc;
      }

      #myMenu {
        list-style: none;
        width: 150px;
        border: 1px solid #ccc;
        border-bottom: none;
        position: absolute;
        display: none;
      }
    </style>

    <template is='dom-if' if='[[isLoading]]'>
      <div class='loading-container'>
        <paper-spinner active alt='Loading'></paper-spinner>
      </div>
    </template>

    <div id="errors">
      <ul></ul>
    </div>

    <div id="warnings">
      <ul></ul>
    </div>

    <div id="debug">
      <ul></ul>
    </div>

    <ul id="myMenu">
      <li>打开中继</li>
      <li>删除设备</li>
      <li></li>
    </ul>
    <button on-click="saveSvg">保存svg</button>
    <div id="floorplan" on-tap="stopPropagation" on-click="stopPropagation"></div>

  </template>
</dom-module>

<script>
  let LINPTECH = "linptech_net"
  let receiver_d ="M512 85.333333C346.88 85.333333 213.333333 218.88 213.333333 384 213.333333 485.546667 264.106667 574.72 341.333333 628.906667L341.333333 725.333333C341.333333 748.8 360.533333 768 384 768L640 768C663.466667 768 682.666667 748.8 682.666667 725.333333L682.666667 628.906667C759.893333 574.72 810.666667 485.546667 810.666667 384 810.666667 218.88 677.12 85.333333 512 85.333333M384 896C384 919.466667 403.2 938.666667 426.666667 938.666667L597.333333 938.666667C620.8 938.666667 640 919.466667 640 896L640 853.333333 384 853.333333 384 896Z"
  let transmitor_d ="M883.74 111.66H140.26A76.34 76.34 0 0 0 64 187.92v648.16a76.34 76.34 0 0 0 76.26 76.26h743.48A76.34 76.34 0 0 0 960 836.08V187.92a76.34 76.34 0 0 0-76.26-76.26zM245.11 550.13a47.66 47.66 0 1 1 47.66-47.66 47.66 47.66 0 0 1-47.66 47.66zM616.85 721.7a38.13 38.13 0 0 1-38.13 38.13H445.28a38.13 38.13 0 0 1-38.13-38.13V302.3a38.13 38.13 0 0 1 38.13-38.13h133.44a38.13 38.13 0 0 1 38.13 38.13zM798 550.13a47.66 47.66 0 1 1 47.66-47.66A47.66 47.66 0 0 1 798 550.13z"

  var selectedElement = 0;
  var currentX = 0;
  var currentY = 0;
  var currentMatrix = 0;

  class HaFloorplan extends Polymer.Element {
    static get is() {
      return 'ha-floorplan';
    }

    static get properties() {
      return {
        hass: {
          type: Object,
          observer: 'hassChanged'
        },
        inDialog: {
          type: Boolean,
          value: false,
        },
        isPanel: {
          type: Boolean,
          value: false,
        },
        config: {
          type: Object,
        },
        isLoading: {
          type: Boolean,
          value: true,
        },
        timeDifference: {
          type: Number,
          value: undefined,
        },
        entityConfigs: {
          type: Array,
          value: () => {
            return [];
          },
        },
        cssRules: {
          type: Array,
          value: () => {
            return [];
          },
        },
        isInitialized: {
          type: Boolean,
          value: false,
        },
        iconScale: {
          type: Number,
          value: undefined,
        },
        is_edit: {
          type: Boolean,
          value: false,
        },

      };
    }

    //1-初始化时被触发。
    connectedCallback() {
      super.connectedCallback();
      if (!this.isInitialized) {
        this.initFloorplan();
      }
    }

    stopPropagation(e) {
      e.stopPropagation();
    }

    // 页面变化时的监听回调函数
    hassChanged(newHass, oldHass) {
      console.log(typeof(newHass.states))
      console.log("info=",newHass.states)
      this.is_edit = newHass.states["linptech.listen"].state=="True"
      if (this.is_edit) {
        this.handleEntitiesInEdit(newHass.states);
      } else {
        this.handleEntitiesInShow(newHass.states);
      }
    }

    //2-实例化面板，进行检查floorplan.yaml配置
    initFloorplan() {
      this.isInitialized = true;
      window.onerror = this.handleWindowError.bind(this);
      // this.hass.connection作用
      this.hass.connection.socket.addEventListener('message', event => {
        let data = JSON.parse(event.data);
        // Store the time difference between the local web browser and the Home Assistant server
        if (data.event && data.event.time_fired) {
          let lastEventFiredTime = moment(data.event.time_fired).toDate();
          this.timeDifference = moment().diff(moment(lastEventFiredTime), 'milliseconds');
        }
      });


      // this.hass.states返回所有实体状态
      this.addExternalCss(() => {
        this.loadFloorPlan(() => {
          this.isLoading = false;
          // this.handleEntitiesInShow(this.hass.states);
        });
      });
    }

    handleWindowError(msg, url, lineNo, columnNo, error) {
      if (msg.toLowerCase().indexOf("script error") >= 0) {
        this.error('Script error: See browser console for detail');
      } else {
        let message = [
          msg,
          'URL: ' + url,
          'Line: ' + lineNo + ', column: ' + columnNo,
          'Error: ' + JSON.stringify(error)
        ].join('<br>');

        this.error(message);
      }

      return false;
    }

    // 加载floorplan.css样式内容
    addExternalCss(callback) {
      if (!this.config.stylesheet) {
        callback();
      }
      // 数据释明this.config.stylesheet：/local/custom_ui/floorplan/floorplan.css
      this.loadStyleSheet(this.config.stylesheet + '?cacheBuster=' + (new Date().getTime()), function (success,
        link) {
        if (success) {
          this.instance.root.appendChild(link);
          let styleSheet = link['sheet'];
          setTimeout(() => {
            this.instance.cssRules = this.instance.getArray(styleSheet.cssRules);
            callback();
          }, 1000);
        } else {
          this.instance.error("Error loading stylesheet");
        }
      }.bind({
        instance: this,
        callback: callback
      }));
    }

    // 通过ajax加载svg文件
    loadFloorPlan(callback) {
      console.log('11=',SVG.supported)
      this.draw=SVG(this.$.floorplan)
      console.log(this.draw)
      this.draw.style({height:'100%',width:'100%', position:'absolute'})
      this.draw.viewbox(0, 0, 400, 300) //可以调整在页面显示的大小
      jQuery.ajax({
        url: this.config.image + '?cacheBuster=' + (new Date().getTime()),
        success: function (result) {
          // 加载floorplan.svg文件内容
          let svg = $(result).find('svg')[0];
          this.instance.draw.svg(svg.innerHTML)
          // 设置icon的scale
          this.instance.iconScale = svg.height.baseVal.value / 20000.0
          
          // 初始化已有接收器和发射器
          let entityConfig = {
            dev_id: undefined,
            dev_type: undefined,
            dev_channel: undefined,
            lastState: undefined,
            lastChangedTime: undefined,
          };

          // 动态创建发射器和接收器图层
          console.log(this.instance.draw.select('#transmitor_layer'))
          if (!$(svg).find('#transmitor_layer').length){
            var transmitor_layer = this.instance.draw.group()
            transmitor_layer.id('transmitor_layer')
          } else {
            for (let transmitor of $(svg).find('#transmitor_layer').children()) {
              entityConfig = {
                dev_id: transmitor.attributes.dev_id.value,
                dev_type: transmitor.attributes.dev_type.value,
                dev_channel: transmitor.attributes.dev_channel.value,
              }
              this.instance.entityConfigs[transmitor.id] = entityConfig
            }
          }
          if (!$(svg).find('#receiver_layer').length) {
            var receiver_layer = this.instance.draw.group()
            receiver_layer.id('receiver_layer')
          } else {
            for (let receiver of $(svg).find('#receiver_layer').children()) {
              entityConfig = {
                dev_id: receiver.attributes.dev_id.value,
                dev_type: receiver.attributes.dev_type.value,
                dev_channel: receiver.attributes.dev_channel.value,
              }
              this.instance.entityConfigs[receiver.id] = entityConfig
              receiver.addEventListener("click", this.instance.onEntityClick.bind(this.instance), false);
              receiver.addEventListener("mousedown", this.instance.selectElement.bind(this.instance), false)
              if (!this.instance.hass.states[receiver.id]) {
                var data = {}
                data['device_id'] = receiver.attributes.dev_id.value;
                data['device_type'] = receiver.attributes.dev_type.value;
                data['device_channel'] = receiver.attributes.dev_channel.value;
                console.log(this.instance.hass)
                this.instance.hass.callService(LINPTECH, "load_device", data)
              }
            }
          }
          this.callback();
        }.bind({
          instance: this,
          callback: callback
        })
      });
    }

    // 处理hass.states
    handleEntitiesInEdit(entities) {
      var svg = this.$.floorplan.querySelector('group');
      var swithX = 0
      var switchY = 0
      var lightX = 0
      var lightY = 1000
      console.log(this.draw)
      for (let entityId in entities) {
        let entityState = entities[entityId];
        // 判断改id是否存在，不存在要增加，存在就更新状态
        let entityConfig = this.entityConfigs[entityId];
        if (!entityConfig && this.iconScale) {
          // 增加设备，发射器和接收器分开
          this.entityConfigs[entityId] = {
            dev_id: entityState.attributes.id,
            dev_type: entityState.attributes.type,
            dev_channel: entityState.attributes.dev_channel,
          }
          if (entityId.startsWith('switch')) {
            var transmitor = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            transmitor.setAttribute('dev_id', entityState.attributes.id);
            transmitor.setAttribute('dev_type', entityState.attributes.type);
            transmitor.setAttribute('dev_channel', entityState.attributes.channel);
            transmitor.setAttribute('id', entityId)
            transmitor.setAttribute('d', transmitor_d)
            transmitor.setAttribute('transform', "scale(" + this.iconScale + "),translate(" + swithX + "," +
              switchY + ")")
            // transmitor.addEventListener("click", this.onEntityClick.bind(this));
            $(svg).find('#transmitor_layer').append(transmitor)
            swithX += 1000
          }
          if (entityId.startsWith('light')) {
            var receiver = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            receiver.setAttribute('id', entityId)
            receiver.setAttribute('dev_id', entityState.attributes.id);
            receiver.setAttribute('dev_type', entityState.attributes.type);
            receiver.setAttribute('dev_channel', entityState.attributes.channel);
            
            receiver.setAttribute('d', receiver_d)
            receiver.addEventListener("click", this.onEntityClick.bind(this), false);
            // $(receiver).addClass("draggable")
            receiver.addEventListener("mousedown", this.selectElement.bind(this), false)
            receiver.setAttribute('transform', "scale(" + this.iconScale + "),translate(" + lightX + "," + lightY +
              ")")
            $(svg).find('#receiver_layer').append(receiver)
            lightX += 1000
          }
        } else {
          // console.log("old entityState=",entityState)
        }
      }
    }

    handleEntitiesInShow(entities) {
      console.log("in show")
    }

    //展示模式下，点击实现开关功能
    onEntityClick(e) {
      e.stopPropagation();
      if (!this.is_edit) {
        let current = e.currentTarget;
        let data = {}
        data['entity_id'] = current.id
        this.hass.callService('homeassistant', 'toggle', data);
      }
    }

    //编辑模式下，点击显示菜单
    showMenu(event) {
      event.preventDefault();
      let myMenu = this.$.myMenu;
      console.log(myMenu)
      myMenu.style.display = "block";
      //获取鼠标视口位置
      myMenu.style.top = event.clientY + "px";
      myMenu.style.left = event.clientX + "px";
    }

    // 编辑模式下，点击实现选中可以拖拽

    selectElement(event) {
      event.stopPropagation();
      if(this.is_edit) {
        selectedElement = event.currentTarget;
        console.log(selectedElement.getBBox())
        currentX = event.clientX;
        currentY = event.clientY;
        currentMatrix = selectedElement.getBBox();
        console.log(currentX, currentY, currentMatrix)
        
        selectedElement.addEventListener("mousemove", this.moveElemnet.bind(this));
        selectedElement.addEventListener("mouseup",this.deselectElement.bind(this));
        selectedElement.addEventListener("mouseout", this.deselectElement.bind(this));
      }
    }

    // moveElemnet(event) {
    //   var dx = event.clientX - currentX
    //   var dy = event.clientY - currentY
    //   currentMatrix.x += dx
    //   currentMatrix.y += dy
    //   selectedElement.setAttribute("BBox",currentMatrix)
    //   console.log(selectedElement.getBBox())
    //   currentX = event.clientX;
    //   currentY = event.clientY;
    // }

    // deselectElement(evt) {
    //   if (selectedElement != 0) {
    //     selectedElement.removeAttributeNS(null, "onmousemove");
    //     selectedElement.removeAttributeNS(null, "onmouseout");
    //     selectedElement.removeAttributeNS(null, "onmouseup");
    //     selectedElement = 0;
    //   }
    // }

    // 保存svg，调用后台的服务
    saveSvg() {
      let svg = this.$.floorplan.querySelector('svg');
      let path = this.config.image;
      let data = {};
      data['svg'] = svg.outerHTML;
      data['path'] = path;
      this.hass.callService('linptech_net', 'save_svg', data);
      document.execCommand('Refresh')
    }

    error(message) {
      let errors = this.$.errors;

      $(errors).find('ul').append(`<li>${message}</li>`)
      $(errors).css('display', 'block');
    }

    warn(message) {
      if ((this.config.warnings === null) || (this.config.warnings !== undefined)) {
        let warnings = this.$.warnings;
        console.log("warns=", warnings)
        $(warnings).find('ul').append(`<li>${message}</li>`)
        $(warnings).css('display', 'block');
      }
    }

    debug(message) {
      let debug = this.$.debug;
      $(debug).find('ul').append(`<li>${message}</li>`)
      $(debug).css('display', 'block');
    }

    //创建link标签到head里
    loadStyleSheet(path, fn, scope) {
      let head = document.getElementsByTagName('head')[0]; // reference to document.head for appending/ removing link nodes
      let link = document.createElement('link'); // create the link node
      link.setAttribute('href', path);
      link.setAttribute('rel', 'stylesheet');
      link.setAttribute('type', 'text/css');
      let sheet, cssRules;
      // get the correct properties to check for depending on the browser
      if ('sheet' in link) {
        sheet = 'sheet';
        cssRules = 'cssRules';
      } else {
        sheet = 'styleSheet';
        cssRules = 'rules';
      }

      let interval_id = setInterval(function () { // start checking whether the style sheet has successfully loaded
          try {
            if (link[sheet] && link[sheet][cssRules].length) { // SUCCESS! our style sheet has loaded
              clearInterval(interval_id); // clear the counters
              clearTimeout(timeout_id);
              fn.call(scope || window, true, link); // fire the callback with success == true
            }
          } catch (e) {} finally {}
        }, 10), // how often to check if the stylesheet is loaded
        timeout_id = setTimeout(function () { // start counting down till fail
          clearInterval(interval_id); // clear the counters
          clearTimeout(timeout_id);
          head.removeChild(link); // since the style sheet didn't load, remove the link node from the DOM
          fn.call(scope || window, false, link); // fire the callback with success == false
        }, 15000); // how long to wait before failing

      head.appendChild(link); // insert the link node into the DOM and start loading the style sheet

      return link; // return the link node;
    }

    rgbToHex(rgb) {
      return "#" + ((1 << 24) + (rgb[0] << 16) + (rgb[1] << 8) + rgb[2]).toString(16).slice(1);
    }

    hexToRgb(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, (m, r, g, b) => {
        return r + r + g + g + b + b;
      });

      let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    mix(color1, color2, weight) {
      let p = weight;
      let w = p * 2 - 1;
      let w1 = ((w / 1) + 1) / 2;
      let w2 = 1 - w1;
      let rgb = [
        Math.round(color1.r * w1 + color2.r * w2),
        Math.round(color1.g * w1 + color2.g * w2),
        Math.round(color1.b * w1 + color2.b * w2)
      ];
      return rgb;
    }

    getArray(list) {
      return Array.isArray(list) ? list : Object.keys(list).map(key => list[key]);
    }

    fire(type, detail, options) {
      options = options || {};
      detail = (detail === null || detail === undefined) ? {} : detail;
      const event = new Event(type, {
        bubbles: options.bubbles === undefined ? true : options.bubbles,
        cancelable: Boolean(options.cancelable),
        composed: options.composed === undefined ? true : options.composed
      });
      event.detail = detail;
      const node = options.node || this;
      node.dispatchEvent(event);
      return event;
    }
  }
  customElements.define(HaFloorplan.is, HaFloorplan);

  var HaFloorplanInit = new HaFloorplan()
</script>